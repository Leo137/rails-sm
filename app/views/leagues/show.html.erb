<p id="notice"><%= notice %></p>
<p id="notice"><%= params[:notice] %></p>

<h1><%= @league.name %></h1>
<h4><%= @league.description %></h4>
<div class="label label-default">Organizado por <%= @league.organizer.name %></div>


<% if Time.now < @league.start_date %>
	<span class="label label-info">Esta liga todavia no ha comenzado!</span>
<% else %>
	<% if Time.now >= @league.start_date && Time.now < @league.finish_date %>
		<span class="label label-default">Liga ya ha comenzado</span>
	<% else %>
		<span class="label label-danger">Liga finalizada</span>
	<% end %>
<% end %>

<% if @league.users.count > 0 %>
<h2>Contestants</h2>
	<table class="table">
	  <thead>
	    <tr>
	      <th>Name</th>
	      <th colspan="3"></th>
	    </tr>
	  </thead>

	  <tbody>
	    <% @league.users.each do |user| %>
	      <tr>
	        <td><%= link_to user.name, controller: "users", action: "show", id: user.server_id %></td>
	      </tr>
	    <% end %>
	  </tbody>
	</table>
<% else %>
	<h2>No Contestants yet</h2>
<% end %>

<% if @league.songs.count > 0 %>
<h2>Scores</h2>
	<table class="table">
	  <thead>
	    <tr>
	      <th>Usuario</th>
	      <% @league.songs.each do |song| %>
	      	<th><%= link_to song.name, controller: "songs", action: "show", id: song.id %></th>
	      <% end %>
	      <th>Puntos totales</th>
	      <th colspan="3"></th>
	    </tr>
	  </thead>
	  <% users_ordered = [] %>
	  <% @league.users.each do |user| %>
	  	<% users_ordered = users_ordered.push({"user" => user, "score" => 0.0}) %>
	  	<% @league.songs.each do |song| %>
	  		<% league_song = @league.league_songs.where("song_id =?", song.id).first %>
	  		<% score = user.user_scores.where("song_id =? AND server_date >=? AND server_date <=?", song.id,@league.start_date,@league.finish_date).order(server_migs_dp_obtained: :desc).first %>
	  		<% if score != nil %>
	  			<% (users_ordered[users_ordered.length-1])["score"] = (users_ordered[users_ordered.length-1])["score"] + (league_song.factor * score.server_migs_dp_obtained).round(2) %>
	  		<% end %>
	  	<% end %>
	  	<% users_ordered.sort! { |x,y| y["score"] <=> x["score"] } %>
	  <% end %>

	  <tbody>
	    <% users_ordered.each do |u| %>
	      <tr>
	      	<% user = u["user"] %>
	      	<td><%= link_to user.name, controller: "users", action: "show", id: user.server_id %></td>
	      	<% @league.songs.each do |song| %>
	      		<% league_song = @league.league_songs.where("song_id =?", song.id).first %>
		      	<% score = user.user_scores.where("song_id =? AND server_date >=? AND server_date <=?", song.id,@league.start_date,@league.finish_date).order(server_migs_dp_obtained: :desc).first %>
		      	<% if score != nil %>
		      		<td><%= score.server_percent %>% (Puntos: <%= (league_song.factor * score.server_migs_dp_obtained).round(2) %>)</td>
		      	<% else %>
		      		<td>--</td>
		      	<% end %>
	      	<% end %>
	      	<td><%= u["score"] %></td>
	      </tr>
	    <% end %>
	  </tbody>
	</table>
<% else %>
	<h2>No Songs yet</h2>
<% end %>



<% if @league.organizer == current_user %>
	<%= form_tag(edit_league_path(@league), method: "get") do %>
	  	<%= submit_tag("Administrar liga", class: "btn btn-default pull-left") %>
	<% end %>
	<span></span>
	<%= form_tag(leagues_add_song_path, method: "get") do %>
		<%= hidden_field_tag(:id, @league.id) %>
	  	<%= submit_tag("Administrar canciones", class: "btn btn-default pull-left") %>
	<% end %>
<% end %>

<% @user = @league.users.find(current_user.id) rescue nil %>
<% if current_user != nil %>
	<% if @user == nil %>
	    <%= form_tag(leagues_join_league_path, method: "post") do %>
		    <%= hidden_field_tag(:userid, current_user.id) %>
		    <%= hidden_field_tag(:leagueid, @league.id) %>
		    <%= submit_tag("Join League", class: "btn btn-default pull-right") %>
		<% end %>
	<% else %>
		<% if Time.now < @league.finish_date %>
			<%= form_tag(leagues_join_league_path, method: "delete") do %>
			    <%= hidden_field_tag(:userid, current_user.id) %>
			    <%= hidden_field_tag(:leagueid, @league.id) %>
			    <%= submit_tag("Leave League", class: "btn btn-default pull-right") %>
			<% end %>
		<% end %>
	<% end %>
<% end %>